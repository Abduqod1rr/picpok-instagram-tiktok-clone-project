{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PicPok | Home</title>
  <link rel="stylesheet" href="{% static 'home.css' %}">
  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: 'Poppins', sans-serif;
      scroll-snap-type: y mandatory;
      overflow-y: scroll;
    }

    nav {
      position: fixed;
      top: 0;
      width: 100%;
      background: rgba(0,0,0,0.85);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 25px;
      z-index: 10;
      backdrop-filter: blur(8px);
    }
    .logo { font-weight: bold; font-size: 1.4rem; color: #ff375f; }
    .nav-links a { color: #fff; text-decoration: none; margin-left: 20px; }
    .nav-links a:hover { color: #ff375f; }

    .search-container { margin-top: 80px; text-align: center; padding: 10px; }
    .search-container input {
      width: 70%; padding: 10px 15px;
      border-radius: 25px; border: none; outline: none;
      background: #222; color: white;
    }

    .post-card {
      scroll-snap-align: start;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      position: relative;
    }
    .post-card img, .post-card video {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 0;
    }

    .overlay {
      position: relative;
      z-index: 2;
      background: linear-gradient(to top, rgba(0,0,0,0.75), transparent);
      padding: 25px;
    }
    .caption { font-size: 1.4rem; font-weight: 600; margin: 0; }
    .author { font-size: 1rem; opacity: 0.8; margin: 0; }

    .like-btn {
      position: absolute;
      top: 20px;
      right: 25px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: 6px 12px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s ease;
      z-index: 3;
    }
    .like-btn:hover { background: #ff375f; }

    /* ==== COMMENTS ==== */
    .comment-section {
      display: none;
      background: rgba(0,0,0,0.7);
      padding: 12px 18px;
      border-radius: 12px;
      margin: 10px 25px 30px;
      backdrop-filter: blur(5px);
    }
    .comment { font-size: 0.95rem; margin: 8px 0; }
    .comment strong { color: #ff375f; }

    .comment-form textarea {
      width: 100%;
      padding: 8px;
      border-radius: 10px;
      border: none;
      background: #222;
      color: white;
      resize: none;
    }
    .comment-form button {
      margin-top: 8px;
      padding: 6px 12px;
      border: none;
      border-radius: 10px;
      background: #ff375f;
      color: white;
      cursor: pointer;
      font-weight: 600;
    }
    .comment-form button:hover { background: #ff5775; }

    .show-comments-btn {
      position: relative;
      z-index: 3;
      margin: 10px 25px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 6px 12px;
      cursor: pointer;
      font-weight: 500;
      transition: 0.2s ease;
    }
    .show-comments-btn:hover { background: #ff375f; }

  </style>
</head>
<body>
  <nav>
    <div class="logo">picpok</div>
    <div class="nav-links">
      <a href="{% url 'home' %}">Home</a>
      <a href="{% url 'addpoc' %}">Add</a>
      <a href="{% url 'mypocs' %}">My Posts</a>
      <a href="{% url 'myprofile' %}">Profile</a>
      <a href="{% url 'logout' %}">Logout</a>
    </div>
  </nav>

  <div class="search-container">
    <form method="get">
      <input type="text" name="q" placeholder="Search posts..." value="{{ request.GET.q }}">
    </form>
  </div>

  {% for poc in pocs %}
  <div class="post-card">
    {% if poc.content %}
      {% if ".mp4" in poc.content.url|lower %}
        <video src="{{ poc.content.url }}" autoplay muted playsinline loop></video>
      {% else %}
        <img src="{{ poc.content.url }}" alt="{{ poc.title }}">
      {% endif %}
    {% endif %}

    <form action="{% url 'toggle_like' poc.id %}" method="post">
      {% csrf_token %}
      <button type="submit" class="like-btn">{{ poc.like.count }}</button>
    </form>

    <div class="overlay">
      <p class="caption">{{ poc.title }}</p>
      <p class="author">@{{ poc.owner }}</p>
    </div>

    <button class="show-comments-btn" onclick="toggleComments({{ poc.id }})">ðŸ’¬ Comments</button>

    <div class="comment-section" id="comments-{{ poc.id }}">
      {% for c in poc.comment_set.all %}
        <div class="comment"><strong>@{{ c.comment_owner.username }}</strong>: {{ c.text }}</div>
      {% empty %}
        <p>No comments yet...</p>
      {% endfor %}

      <form action="{% url 'add_comment' poc.id %}" method="post" class="comment-form">
        {% csrf_token %}
        <textarea name="text" rows="2" placeholder="Add a comment..." required></textarea>
        <button type="submit">Post</button>
      </form>
    </div>
  </div>
  {% endfor %}

  <script>
    // faqat 1 ta commentni koâ€˜rsatish
    document.querySelectorAll('.comment-section').forEach(sec => {
      const comments = sec.querySelectorAll('.comment');
      comments.forEach((c, i) => {
        if (i > 0) c.style.display = "none";
      });
    });

    // Tugmani bosganda barcha commentlarni koâ€˜rsatish / yopish
    function toggleComments(id) {
      const section = document.getElementById(`comments-${id}`);
      const comments = section.querySelectorAll('.comment');
      const isExpanded = section.classList.toggle('expanded');

      comments.forEach((c, i) => {
        if (!isExpanded && i > 0) c.style.display = "none";
        else c.style.display = "block";
      });

      section.style.display = isExpanded ? "block" : "none";
    }
  </script>
</body>
</html>
